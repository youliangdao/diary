---
author_association: OWNER
created_at: '2022-08-20T03:38:09Z'
html_url: https://github.com/youliangdao/diary/issues/2#issuecomment-1221223806
id: 1221223806
issue_url: https://api.github.com/repos/youliangdao/diary/issues/2
node_id: IC_kwDOH2O6185IymV-
performed_via_github_app: 
reactions:
  "+1": 0
  "-1": 0
  confused: 0
  eyes: 0
  heart: 0
  hooray: 0
  laugh: 0
  rocket: 0
  total_count: 0
  url: https://api.github.com/repos/youliangdao/diary/issues/comments/1221223806/reactions
updated_at: '2022-08-20T03:38:09Z'
url: https://api.github.com/repos/youliangdao/diary/issues/comments/1221223806
user:
  avatar_url: https://avatars.githubusercontent.com/u/72332502?v=4
  events_url: https://api.github.com/users/youliangdao/events{/privacy}
  followers_url: https://api.github.com/users/youliangdao/followers
  following_url: https://api.github.com/users/youliangdao/following{/other_user}
  gists_url: https://api.github.com/users/youliangdao/gists{/gist_id}
  gravatar_id: ''
  html_url: https://github.com/youliangdao
  id: 72332502
  login: youliangdao
  node_id: MDQ6VXNlcjcyMzMyNTAy
  organizations_url: https://api.github.com/users/youliangdao/orgs
  received_events_url: https://api.github.com/users/youliangdao/received_events
  repos_url: https://api.github.com/users/youliangdao/repos
  site_admin: false
  starred_url: https://api.github.com/users/youliangdao/starred{/owner}{/repo}
  subscriptions_url: https://api.github.com/users/youliangdao/subscriptions
  type: User
  url: https://api.github.com/users/youliangdao

---
```
require "erb"

class View
end

class Template
  def initialize(name, content, locals)
    @name = name
    @content = content
    @locals = locals
  end

  def render(view, local_assigns)
    compile(view)
    view.send(@name, local_assigns)
  end

  def compile(view)
    return if @compiled
    body = ERB.new(@content).src

    src = <<-end_src
      def #{@name}(local_assigns)
        #{locals_code}
        #{body}
      end
    end_src

    view.singleton_class.module_eval(src)

      @compiled = true
  end

  def locals_code
    @locals.map do |local|
      "#{local} = local_assigns[:#{local}]"
    end.join("\n")
  end
end

view = View.new
template = Template.new("say_hi", "Hi! <%= name %>", [:name])
template.render(view, name: "Stan") #=> Hi! Stan
```
templateのコンパイル部分。

動的にメソッドを定義しているのがわかる。これがRubyの凄さやなぁ...Railsの抽象化はメタプロが大きい気がする
